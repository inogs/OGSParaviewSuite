## OGS Spatial Statistics

The **OGS Spatial Statistics** filter is able to generate the following nine statistics to any part (or the whole) Mediterranean sea:

* Mean
* Standard deviation (std)
* Minimum (min)
* Maximum (max)
* Percentile 5% (p05)
* Percentile 25% (p25)
* Percentile 50% (p50)
* Percentile 75% (p75)
* Percentile 95% (p95)

Although this fitler can be used under any kind of data, cell data is strongly advised. 

By default, the weighting used is the cell area (e1te2t) although the user can select to use the cell volume (e1te2te3t). In any case, it is necessary to load the mesh weights for this filter to work. If the mesh does not change in time, the user can deactivate the _Changing Mesh Flag_ to speed up the computations. Deactivating this flag in a changing mesh can result in **Segmentation faults**.

Moreover, as default, the code generated an average per depth level (that is scanned at the beginning). Alternatively, the user can decide to provide depth levels by inputting them in the selection box. Note that the levels go from 0 to the selected value and so on until the bottom is reached.

This filter has  been validated against the **OGS Spatial Stats from File** filter and produces the same results under the same circumstances.

### Computation of the statistics

The computation of the statistics deserves a special mention. The general naive approach to compute the standard deviation takes two loops on the mesh: a first one for the mean and a second for the variance.

Welford (1962) proposed an algorithm to comptue the variance in a single loop. West (1979) extended the method for weighted computations using a recursive algorithm:

<img src="https://github.com/inogs/OGSParaviewSuite/blob/master/OGSPlugins/OGSSpatialStats/doc/eq1.png" alt="" width="330"/>

where the mean and standard deviation can be computed acummulating over _i_ until _n_.

A parallel algorithm was proposed by Chan (1979). the magnitudes are basically computed as described before for each sub-domain and the following recursive reduction is used:

<img src="https://github.com/inogs/OGSParaviewSuite/blob/master/OGSPlugins/OGSSpatialStats/doc/eq2.png" alt="" width="200"/>

This reduction of domains A and B requires to store the partial computations of the weights, mean and variance for each sub-domain:

<img src="https://github.com/inogs/OGSParaviewSuite/blob/master/OGSPlugins/OGSSpatialStats/doc/eq3.png" alt="" width="120"/>

A similar reduction can be implemented for the standard deviation:

<img src="https://github.com/inogs/OGSParaviewSuite/blob/master/OGSPlugins/OGSSpatialStats/doc/eq4.png" alt="" width="400"/>

the total standard derviation need to be divided by the sum of all the weights.

For the percentiles, it is necessary to order the values first (and retain the indices). Then, a percentile weight can be computed as:

<img src="https://github.com/inogs/OGSParaviewSuite/blob/master/OGSPlugins/OGSSpatialStats/doc/eq5.png" alt="" width="200"/>

where _'_ denotes the sorted weight. Then, the index of the value that is equal or immediately lower than the percentile weight must be obtained (e.g., for 50% the search is for wp = 0.5 or the imediately before). This index is called _s_, then (e.g., for 50%):

<img src="https://github.com/inogs/OGSParaviewSuite/blob/master/OGSPlugins/OGSSpatialStats/doc/eq6.png" alt="" width="200"/>

## OGS Spatial Stats from File

The **OGS Spatial Stats from File** loads the data from the _STAT_PROFILES_ generated by _avescan_ into ParaView. Some restrictions apply to this filter:

* Due to the nature of the algorithm itself and the data generated by _avescan_ (from _bit.sea_), this code **must** have a _vtkRectilinearGrid_ and must output a _vtkRectilinearGrid_.
* For a correct time exploration, a _STAT_PROFILE_ for each timestep **must** be generated.
* The files must contain all the averages as outputed by _avescan_ in the form **var(sub,coast,z,stat)**.
* The file name must be like **ave.<date>.stat_profiles.nc**.

There are a total of nine statistics considered:

* Mean
* Standard deviation (std)
* Minimum (min)
* Maximum (max)
* Percentile 5% (p05)
* Percentile 25% (p25)
* Percentile 50% (p50)
* Percentile 75% (p75)
* Percentile 95% (p95)

The results od these nine statistics will override whatever variables loaded on the mesh. A warning is raised if the variable is not found and the statistics cannot be loaded. This warning does not stop ParaView from executing.